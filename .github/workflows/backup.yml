name: GitVault

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get commit hash
      id: commit
      run: echo "hash=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Create tarball of entire repo
      id: archive
      run: |
        TAR_PATH="/tmp/repo.tar.gz"
        tar --exclude='.git' --exclude='*.tar.gz' -czf "$TAR_PATH" .
        echo "path=$TAR_PATH" >> $GITHUB_OUTPUT
        echo "size=$(stat -c%s "$TAR_PATH")" >> $GITHUB_OUTPUT

    - name: Upload to Supabase
      id: upload
      env:
        API_URL: "https://4057-2409-40d0-1000-be8d-ba3d-7522-a11d-4d93.ngrok-free.app/api/my-upload/upload"
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "ðŸ”„ Uploading archive to $API_URL..."

        RESPONSE=$(curl -s -X POST "$API_URL" \
          -H "Authorization: Bearer $GITHUB_TOKEN" \
          -H "X-GitHub-Repository: $GITHUB_REPOSITORY" \
          -H "X-GitHub-Commit-Hash: ${{ steps.commit.outputs.hash }}" \
          -H "X-GitHub-Run-Id: $GITHUB_RUN_ID" \
          -H "X-Backup-Owner: ${{ github.repository_owner }}" \
          -F "file=@${{ steps.archive.outputs.path }}" \
          --retry 3 --retry-delay 2)

        echo "ðŸ“¦ Upload response: $RESPONSE"

        SUPA_KEY=$(echo "$RESPONSE" | jq -r '.supabaseKey')
        SIGNED_URL=$(echo "$RESPONSE" | jq -r '.signedUrl')

        if [[ -z "$SUPA_KEY" || "$SUPA_KEY" == "null" ]]; then
          echo "âŒ Upload failed: No supabaseKey"
          exit 1
        fi

        echo "supabaseKey=$SUPA_KEY" >> $GITHUB_OUTPUT
        echo "signedUrl=$SIGNED_URL" >> $GITHUB_OUTPUT

    - name: Generate HMAC Signature
      id: hmac
      env:
        HMAC_SECRET: ${{ secrets.HMAC_SECRET }}
      run: |
        REPO_COMMIT="${GITHUB_REPOSITORY}:${{ steps.commit.outputs.hash }}"
        SIG=$(echo -n "$REPO_COMMIT" | openssl dgst -sha256 -hmac "$HMAC_SECRET" | sed 's/^.* //')
        echo "sig=$SIG"
        echo "sig=$SIG" >> $GITHUB_OUTPUT

    - name: ðŸš€ Trigger Storacha Upload on Server
      id: storacha
      if: ${{ success() }}
      env:
        SERVER_URL: "https://4057-2409-40d0-1000-be8d-ba3d-7522-a11d-4d93.ngrok-free.app/api/my-upload/storacha-upload"
        AUTH_TOKEN: ${{ secrets.STORACHA_TRIGGER_SECRET }}

      run: |
        echo "ðŸ” Calling server to pull from Supabase and upload to Storacha..."

        JSON=$(jq -n \
          --arg repo "${GITHUB_REPOSITORY}" \
          --arg commit "${{ steps.commit.outputs.hash }}" \
          --arg supa "${{ steps.upload.outputs.supabaseKey }}" \
          --arg url "${{ steps.upload.outputs.signedUrl }}" \
          --arg sig "${{ steps.hmac.outputs.sig }}" \
          '{repo: $repo, commit: $commit, supabaseKey: $supa, signedUrl: $url, sig: $sig}')

        RESPONSE=$(curl -s -X POST "$SERVER_URL" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $AUTH_TOKEN" \
          -d "$JSON")

        echo "ðŸŒ Storacha response: $RESPONSE"

        CID=$(echo "$RESPONSE" | jq -r '.cid')
        IPFS_URL=$(echo "$RESPONSE" | jq -r '.url')

        if [[ "$CID" == "null" || -z "$CID" ]]; then
          echo "âŒ Failed to retrieve CID"
          exit 1
        fi

        echo "cid=$CID" >> $GITHUB_OUTPUT
        echo "ipfs_url=$IPFS_URL" >> $GITHUB_OUTPUT
    - name: ðŸ—‘ï¸ Delete temp from Supabase
      if: always()
      env:
        DELETE_URL: " https://4057-2409-40d0-1000-be8d-ba3d-7522-a11d-4d93.ngrok-free.app/api/my-upload/delete"
        DELETE_SECRET: ${{ secrets.SUPABASE_DELETE_SECRET }}
      run: |
        echo "ðŸ§¹ Cleaning up Supabase temp file..."
  
        curl -s -X POST "$DELETE_URL" \
          -H "Authorization: Bearer $DELETE_SECRET" \
          -H "Content-Type: application/json" \
          -d "{\"key\": \"${{ steps.upload.outputs.supabaseKey }}\"}"

    - name: Update .gitvault and README
      if: success()
      run: |
        CID=${{ steps.storacha.outputs.cid }}
        URL=${{ steps.storacha.outputs.ipfs_url }}

        if [ ! -f .gitvault ]; then
          echo "repository:" > .gitvault
          echo "  name: $GITHUB_REPOSITORY" >> .gitvault
          echo "backups:" >> .gitvault
        fi

        echo "- cid: $CID" >> .gitvault
        echo "  date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> .gitvault
        echo "  commit: ${{ steps.commit.outputs.hash }}" >> .gitvault

        if [ -f README.md ]; then
          sed -i '/\[!\[GitVault Backup/d' README.md
          sed -i "1i [![GitVault Backup](https://img.shields.io/badge/GitVault-Protected-blue)]($URL)" README.md
        else
          echo "[![GitVault Backup](https://img.shields.io/badge/GitVault-Protected-blue)]($URL)" > README.md
        fi

        git config user.name "GitVault Bot"
        git config user.email "bot@gitvault.xyz"

        # Fetch remote changes and reset to match remote state
        git fetch origin main
        git reset --hard origin/main

        git add .gitvault README.md
        git commit -m "Update GitVault backup [skip ci]" || echo "âœ… Nothing to commit"
        git push origin main


